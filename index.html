<!DOCTYPE html>
<html lang="it">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>RisoTrack - Gestione Business Riso</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://d3js.org/d3.v7.min.js"></script>

Â  Â  Â  Â  <link rel="manifest" href="/manifest.json">
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes"> 
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black">
Â  Â  Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f7f9fb;
Â  Â  Â  Â  }
Â  Â  Â  Â  .text-rice { color: #5a3c20; }
Â  Â  Â  Â  .bg-rice { background-color: #f0e68c; }
Â  Â  Â  Â  /* Stili per il pulsante loading */
Â  Â  Â  Â  .spinner {
Â  Â  Â  Â  Â  Â  border: 4px solid rgba(255, 255, 255, 0.3);
Â  Â  Â  Â  Â  Â  border-top: 4px solid #fff;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 16px;
Â  Â  Â  Â  Â  Â  height: 16px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  .chart-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  border: 1px solid #e5e7eb;
Â  Â  Â  Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chart-svg {
Â  Â  Â  Â  Â  Â  min-width: 600px; /* Base width for chart clarity */
Â  Â  Â  Â  Â  Â  height: 300px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

Â  Â  <div id="app" class="min-h-screen flex flex-col items-center p-4 pb-20">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <header class="w-full max-w-4xl mb-6 bg-white shadow-lg rounded-xl p-4 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-rice">ğŸš RisoTrack</h1>
Â  Â  Â  Â  Â  Â  <div id="auth-status" class="text-sm text-gray-600">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="user-id-display" class="font-mono bg-gray-100 p-1 rounded" title="ID Utente Completo (per debug)">Caricamento utente...</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <div id="loading" class="text-center p-8">
Â  Â  Â  Â  Â  Â  <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full" role="status">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="visually-hidden">Loading...</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500">Inizializzazione Firebase e caricamento dati...</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <main id="main-content" class="w-full max-w-4xl hidden">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <section id="dashboard" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-gray-800">Dashboard & Banche in Tempo Reale</h2>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white shadow-2xl rounded-xl p-6 border-t-4 border-yellow-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-medium text-gray-500">Banca del Riso (Disponibile)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="rice-inventory" class="text-4xl font-extrabold mt-2 text-rice">0 g</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mt-1">Acquisti - Vendite - Uso Personale</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white shadow-2xl rounded-xl p-6 border-t-4 border-green-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-medium text-gray-500">Banca Finanziaria (Netto)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="financial-net" class="text-4xl font-extrabold mt-2 text-gray-800">0,00 â‚¬</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mt-1">Ricavi Totali - Costi Totali</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white shadow-xl rounded-xl p-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-medium text-gray-700 mb-4">Analisi e Riordino Scorte</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="profit-analysis" class="text-center p-8 bg-gray-50 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="average-cost-display" class="font-semibold text-lg text-gray-600">Costo Unitario Medio Storico: N/D</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-4 text-gray-500">La sezione Analisi dettagliata si trova nel tab dedicato in basso.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-12 bg-gray-200 rounded mt-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openStockPlannerModal()" class="mt-6 p-3 w-full bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition shadow-md flex items-center justify-center font-bold">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¦ Pianificatore Scorte e Riordino (AI)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white shadow-xl rounded-xl p-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-medium text-gray-700 mb-4">Azioni Rapide</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openTransactionModal('Acquisto')" class="p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  + Acquisto
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openTransactionModal('Vendita')" class="p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  + Vendita
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openTransactionModal('Uso Personale')" class="p-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Uso Personale
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSection('transactions-list')" class="p-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Storico Trans.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <section id="suppliers-list" class="hidden mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-rice mb-4">Fornitori</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSupplierModal()" class="mb-4 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">+ Nuovo Fornitore</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="suppliers-container" class="space-y-3"></div>
Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <section id="customers-list" class="hidden mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-rice mb-4">Clienti</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showCustomerModal()" class="mb-4 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">+ Nuovo Cliente</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="customers-container" class="space-y-3"></div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="transactions-list" class="hidden mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-rice mb-4">Storico Transazioni</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="transactions-container" class="space-y-3"></div>
Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <section id="analytics-section" class="hidden mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-rice mb-4">Analisi Dati e Grafici</h2>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white shadow-xl rounded-xl p-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-medium text-gray-700 mb-4">Flusso di Riso (Acquisti vs Vendite per Mese)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="flow-chart-container" class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="flow-chart" class="chart-svg"></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mt-2">QuantitÃ  aggregata in grammi per mese. Scorri orizzontalmente se necessario.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white shadow-xl rounded-xl p-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-medium text-gray-700 mb-4">Top 5 Clienti per QuantitÃ  Acquistata (g)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="customer-chart-container" class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <svg id="customer-chart" class="chart-svg"></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mt-2">Visualizzazione dei clienti con il volume di acquisto piÃ¹ alto.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  </main>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <nav class="fixed bottom-0 w-full max-w-4xl bg-white shadow-2xl rounded-t-xl z-10 p-2 border-t border-gray-200">
Â  Â  Â  Â  Â  Â  <div class="flex justify-around text-gray-600 font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSection('dashboard')" class="flex flex-col items-center p-2 text-indigo-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs mt-1">Home</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSection('suppliers-list')" class="flex flex-col items-center p-2 hover:text-indigo-600 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18H4v-1a4 4 0 014-4h4a4 4 0 014 4v1z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs mt-1">Fornitori</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSection('customers-list')" class="flex flex-col items-center p-2 hover:text-indigo-600 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.662.07-1a6.958 6.958 0 00-1.28-4.227 4.989 4.989 0 01-2.685.11 4.989 4.989 0 01-2.684-.11C7.03 12.773 6.904 14.168 7 15.75L7 17h6.93z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs mt-1">Clienti</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSection('analytics-section')" class="flex flex-col items-center p-2 hover:text-indigo-600 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM4 10a6 6 0 016-6v6H4zm8 0a6 6 0 00-6 6v-6h6z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs mt-1">Analisi</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSection('transactions-list')" class="flex flex-col items-center p-2 hover:text-indigo-600 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm10 2a2 2 0 012 2v2a2 2 0 01-2 2h-4a2 2 0 01-2-2V8a2 2 0 012-2h4z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs mt-1">Storico</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </nav>


Â  Â  Â  Â  <div id="transaction-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="transaction-title" class="text-2xl font-bold mb-4 text-rice">Nuova Transazione</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="transaction-form" onsubmit="handleTransaction(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="transaction-type">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="transaction-quantity" class="block text-sm font-medium text-gray-700">QuantitÃ  (g)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="transaction-quantity" min="1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="cost-ricavo-group" class="mb-4 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="transaction-cost" class="block text-sm font-medium text-gray-700">Costo/Ricavo (â‚¬)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="transaction-cost" step="0.01" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="entity-link-group" class="mb-4 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="transaction-entity-link" class="block text-sm font-medium text-gray-700"></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="transaction-entity-link" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="closeTransactionModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Annulla</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Registra</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="supplier-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold mb-4 text-rice">Gestione Fornitore</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="supplier-form" onsubmit="handleSupplier(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="supplier-doc-id">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4"><label for="supplier-name" class="block text-sm font-medium text-gray-700">Nome/Ragione Sociale</label><input type="text" id="supplier-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4"><label for="supplier-alias" class="block text-sm font-medium text-gray-700">Soprannome</label><input type="text" id="supplier-alias" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4"><label for="supplier-phone" class="block text-sm font-medium text-gray-700">Numero di Telefono</label><input type="tel" id="supplier-phone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="supplier-contact-method" class="block text-sm font-medium text-gray-700">Metodo di Contatto</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="supplier-contact-method" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="WhatsApp">WhatsApp</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Telegram">Telegram</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Instagram DM">Instagram DM</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Teleguard">Teleguard</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Email">Email</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Telefono">Telefono</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="supplier-payment-method" class="block text-sm font-medium text-gray-700">Metodo di Pagamento Previsto</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="supplier-payment-method" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Contanti">Contanti</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Satispay">Satispay</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Bancomat/Carta">Bancomat/Carta</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Bonifico">Bonifico</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Crypto">Crypto</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Altro">Altro</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="closeSupplierModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Annulla</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Salva Fornitore</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="customer-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold mb-4 text-rice">Gestione Cliente</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="customer-form" onsubmit="handleCustomer(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="customer-doc-id">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4"><label for="customer-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="customer-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4"><label for="customer-alias" class="block text-sm font-medium text-gray-700">Soprannome/Alias</label><input type="text" id="customer-alias" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4"><label for="customer-phone" class="block text-sm font-medium text-gray-700">Numero di Telefono</label><input type="tel" id="customer-phone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="customer-contact-method" class="block text-sm font-medium text-gray-700">Metodo di Contatto</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="customer-contact-method" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="WhatsApp">WhatsApp</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Telegram">Telegram</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Instagram DM">Instagram DM</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Teleguard">Teleguard</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Email">Email</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Telefono">Telefono</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="customer-payment-method" class="block text-sm font-medium text-gray-700">Metodo di Pagamento Utilizzato</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="customer-payment-method" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Contanti">Contanti</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Satispay">Satispay</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Bancomat/Carta">Bancomat/Carta</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Bonifico">Bonifico</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Crypto">Crypto</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Altro">Altro</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="closeCustomerModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Annulla</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Salva Cliente</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="stock-planner-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold mb-4 text-pink-600">ğŸ“¦ Pianificatore Scorte e Riordino (AI)</h3>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="stock-planner-result-content" class="mt-4 p-4 bg-gray-50 rounded-lg max-h-96 overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-gray-500">Analisi in attesa...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="closeStockPlannerModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Chiudi</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, where, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â  Â  Â  Â  // =======================================================
Â  Â  Â  Â  // ** CONFIGURAZIONE FIREBASE MANUALE (Valori forniti dall'utente) **
Â  Â  Â  Â  // =======================================================

Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  // L'API Key del tuo progetto RisoTrack-Progetto
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyDxdN_63pt-Y-3XopQU96IuqOPrPQBq2AI",Â 
Â  Â  Â  Â  Â  Â  // Il dominio di autenticazione
Â  Â  Â  Â  Â  Â  authDomain: "risotrack-progetto.firebaseapp.com",Â 
Â  Â  Â  Â  Â  Â  // L'ID del tuo progetto (usato per i percorsi Firestore)
Â  Â  Â  Â  Â  Â  projectId: "risotrack-progetto",Â 
Â  Â  Â  Â  Â  Â  // Lo Storage Bucket
Â  Â  Â  Â  Â  Â  storageBucket: "risotrack-progetto.firebasestorage.app",Â 
Â  Â  Â  Â  Â  Â  // Il Messaging Sender ID
Â  Â  Â  Â  Â  Â  messagingSenderId: "5799605184",Â 
Â  Â  Â  Â  Â  Â  // L'App ID (usato per i percorsi Firestore)
Â  Â  Â  Â  Â  Â  appId: "1:5799605184:web:d2722c3efb7166fc994e25",
Â  Â  Â  Â  };

Â  Â  Â  Â  const appId = firebaseConfig.projectId; // Usiamo il Project ID come App ID per il percorso Firestore
Â  Â  Â  Â  const initialAuthToken = null; // Manteniamo a null
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =======================================================
Â  Â  Â  Â  // ** FINE CONFIGURAZIONE MANUALE FIREBASE **
Â  Â  Â  Â  // =======================================================

Â  Â  Â  Â  // =======================================================
Â  Â  Â  Â  // ** CONFIGURAZIONE GEMINI (CHIAVE AGGIORNATA) **
Â  Â  Â  Â  // =======================================================
Â  Â  Â  Â  const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
Â  Â  Â  Â  const apiKey = "AIzaSyAvZFz4G6AokuDPH7bqXQxNlxq13ec0GG4"; // <--- LA TUA CHIAVE API ORA E' QUI
Â  Â  Â  Â  // =======================================================

Â  Â  Â  Â  let app, db, auth;
Â  Â  Â  Â  let userId = null;
Â  Â  Â  Â  let isAuthReady = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Collezioni private (MANDATORIO)
Â  Â  Â  Â  const FORNITORI_COLLECTION = 'fornitori';
Â  Â  Â  Â  const CLIENTI_COLLECTION = 'clienti';
Â  Â  Â  Â  const TRANSAZIONI_COLLECTION = 'transazioni';

Â  Â  Â  Â  // Variabili di Stato Globali
Â  Â  Â  Â  let suppliers = [];
Â  Â  Â  Â  let customers = [];
Â  Â  Â  Â  let transactions = [];
Â  Â  Â  Â  let riceInventory = 0;
Â  Â  Â  Â  let financialNet = 0;
Â  Â  Â  Â  let totalPurchasedQuantity = 0;
Â  Â  Â  Â  let totalPurchasedCost = 0;
Â  Â  Â  Â  let averageUnitCost = 0;
Â  Â  Â  Â  let monthlyConsumption = 0; // Nuovo campo per il consumo medio

Â  Â  Â  Â  // Funzione per formattare la valuta
Â  Â  Â  Â  const formatCurrency = (value) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
Â  Â  Â  Â  // Funzione per formattare la quantitÃ  (grammi)
Â  Â  Â  Â  const formatQuantity = (value) => `${value.toLocaleString('it-IT', { maximumFractionDigits: 0 })} g`;

Â  Â  Â  Â  // Utility per generare un alias carino
Â  Â  Â  Â  function createRiceAlias(uid) {
Â  Â  Â  Â  Â  Â  const riceNames = ["Arborio", "Carnaroli", "Basmati", "Jasmine", "Venere", "Ribe", "Selvatico", "Integrale", "Sushirice", "Originario"];
Â  Â  Â  Â  Â  Â  // Genera un indice numerico deterministico
Â  Â  Â  Â  Â  Â  let sum = 0;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < 8; i++) { // Usa solo i primi 8 caratteri per una maggiore uniformitÃ 
Â  Â  Â  Â  Â  Â  Â  Â  sum += uid.charCodeAt(i);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const nameIndex = sum % riceNames.length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Usa le ultime 4 cifre esadecimali del UID come suffisso
Â  Â  Â  Â  Â  Â  const suffix = uid.slice(-4).toUpperCase();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return `${riceNames[nameIndex]}-${suffix}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 1. INIZIALIZZAZIONE FIREBASE E AUTENTICAZIONE
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  async function initFirebase() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // setLogLevel('Debug');
Â  Â  Â  Â  Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Imposta la persistenza su locale
Â  Â  Â  Â  Â  Â  Â  Â  await setPersistence(auth, browserLocalPersistence);

Â  Â  Â  Â  Â  Â  Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInWithCustomToken(auth, initialAuthToken);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Chiamiamo onAuthStateChanged qui, dopo che auth Ã¨ stato inizializzato.
Â  Â  Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userAlias = createRiceAlias(userId); // Genera l'alias
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-id-display').textContent = `Utente: ${userAlias}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-id-display').title = `ID Completo: ${userId}`; // Tooltip con l'ID intero
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAuthReady = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Avvia i listener solo dopo che l'autenticazione Ã¨ pronta
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startFirestoreListeners();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('main-content').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSection('dashboard'); // Mostra la dashboard come sezione iniziale

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Nessun utente autenticato. Tentativo di accesso anonimo...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore nell'inizializzazione o nell'autenticazione di Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  // MESSAGGIO DI ERRORE DETTAGLIATO PER IL BUG auth/configuration-not-found
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-red-500 font-bold text-lg">Errore di Connessione al Database (Firebase):</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700 mt-2">Errore: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700 mt-4 p-3 bg-red-100 rounded-lg border border-red-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L'errore '${error.code}' indica che Firebase Auth non riesce a trovare la configurazione.Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Per risolvere questo problema, devi andare nella console Firebase**, sezioneÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Authentication**, tab **Sign-in method**, e assicurarti che il metodo di accessoÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Anonimo** sia **Abilitato** (lo usiamo per autenticarti automaticamente).
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Inoltre, controlla le **Regole di Sicurezza** di Firestore.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 2. FUNZIONI DI BASE PER FIRESTORE
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  const getCollectionPath = (collectionName) => {
Â  Â  Â  Â  Â  Â  if (!userId) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("UserID non disponibile.");
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return `artifacts/${appId}/users/${userId}/${collectionName}`;
Â  Â  Â  Â  };

Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 3. LOGICA DI CALCOLO E AGGIORNAMENTO UI
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  function calculateMonthlyConsumption() {
Â  Â  Â  Â  Â  Â  const consumption = transactions.filter(t => t.tipo === 'Vendita' || t.tipo === 'Uso Personale');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (consumption.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  monthlyConsumption = 0;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const oldestDate = consumption.reduce((min, t) => {
Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(t.data);
Â  Â  Â  Â  Â  Â  Â  Â  return date < min ? date : min;
Â  Â  Â  Â  Â  Â  }, now);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const timeDiff = now.getTime() - oldestDate.getTime();
Â  Â  Â  Â  Â  Â  const totalDays = timeDiff / (1000 * 3600 * 24);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (totalDays < 1) { // Consumo inferiore a un giorno
Â  Â  Â  Â  Â  Â  Â  Â  Â monthlyConsumption = d3.sum(consumption, d => parseFloat(d.quantita) || 0) * 30; // Stima a 30 giorni
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const totalConsumption = d3.sum(consumption, d => parseFloat(d.quantita) || 0);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Calcola il consumo medio giornaliero e lo moltiplica per 30.44 (media giorni in un mese)
Â  Â  Â  Â  Â  Â  const dailyConsumption = totalConsumption / totalDays;
Â  Â  Â  Â  Â  Â  monthlyConsumption = dailyConsumption * 30.44;
Â  Â  Â  Â  }


Â  Â  Â  Â  function updateCalculations() {
Â  Â  Â  Â  Â  Â  let totalAcquisto = 0;
Â  Â  Â  Â  Â  Â  let totalVendita = 0;
Â  Â  Â  Â  Â  Â  let totalUsoPersonale = 0;
Â  Â  Â  Â  Â  Â  let totalCosti = 0;
Â  Â  Â  Â  Â  Â  let totalRicavi = 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  totalPurchasedQuantity = 0;
Â  Â  Â  Â  Â  Â  totalPurchasedCost = 0;

Â  Â  Â  Â  Â  Â  transactions.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const quantity = parseFloat(t.quantita) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const cost = parseFloat(t.costo) || 0; // Usiamo 'costo' per Acquisto e Ricavo per Vendita

Â  Â  Â  Â  Â  Â  Â  Â  if (t.tipo === 'Acquisto') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalAcquisto += quantity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCosti += cost;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalPurchasedQuantity += quantity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalPurchasedCost += cost;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (t.tipo === 'Vendita') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalVendita += quantity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalRicavi += cost;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (t.tipo === 'Uso Personale') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalUsoPersonale += quantity;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Calcoli Principali
Â  Â  Â  Â  Â  Â  riceInventory = totalAcquisto - totalVendita - totalUsoPersonale;
Â  Â  Â  Â  Â  Â  financialNet = totalRicavi - totalCosti;
Â  Â  Â  Â  Â  Â  averageUnitCost = totalPurchasedQuantity > 0 ? totalPurchasedCost / totalPurchasedQuantity : 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Calcolo Consumo Medio
Â  Â  Â  Â  Â  Â  calculateMonthlyConsumption();

Â  Â  Â  Â  Â  Â  // Aggiornamento UI
Â  Â  Â  Â  Â  Â  document.getElementById('rice-inventory').textContent = formatQuantity(riceInventory);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const financialDisplay = document.getElementById('financial-net');
Â  Â  Â  Â  Â  Â  financialDisplay.textContent = formatCurrency(financialNet);
Â  Â  Â  Â  Â  Â  financialDisplay.className = financialNet >= 0 ? 'text-4xl font-extrabold mt-2 text-green-600' : 'text-4xl font-extrabold mt-2 text-red-600';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Analisi
Â  Â  Â  Â  Â  Â  const costDisplay = document.getElementById('average-cost-display');
Â  Â  Â  Â  Â  Â  costDisplay.textContent = averageUnitCost > 0Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? `Costo Unitario Medio Storico: ${formatCurrency(averageUnitCost)}/g`
Â  Â  Â  Â  Â  Â  Â  Â  : 'Costo Unitario Medio Storico: N/D (Nessun acquisto registrato)';

Â  Â  Â  Â  Â  Â  renderTransactionList();
Â  Â  Â  Â  Â  Â  renderSuppliersList();
Â  Â  Â  Â  Â  Â  renderCustomersList();
Â  Â  Â  Â  Â  Â  // renderAnalytics() non viene chiamato qui per evitare errori di D3 se non Ã¨ il tab attivo, verrÃ  chiamato in showSection.
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 4. LISTENER FIRESTORE (Real-time)
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  function startFirestoreListeners() {
Â  Â  Â  Â  Â  Â  if (!isAuthReady) return;

Â  Â  Â  Â  Â  Â  // Listener Fornitori
Â  Â  Â  Â  Â  Â  const fornitoriQ = collection(db, getCollectionPath(FORNITORI_COLLECTION));
Â  Â  Â  Â  Â  Â  onSnapshot(fornitoriQ, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  updateCalculations();
Â  Â  Â  Â  Â  Â  Â  Â  populateEntitySelects();
Â  Â  Â  Â  Â  Â  }, (error) => console.error("Errore listener Fornitori:", error));

Â  Â  Â  Â  Â  Â  // Listener Clienti
Â  Â  Â  Â  Â  Â  const clientiQ = collection(db, getCollectionPath(CLIENTI_COLLECTION));
Â  Â  Â  Â  Â  Â  onSnapshot(clientiQ, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  updateCalculations();
Â  Â  Â  Â  Â  Â  Â  Â  populateEntitySelects();
Â  Â  Â  Â  Â  Â  }, (error) => console.error("Errore listener Clienti:", error));

Â  Â  Â  Â  Â  Â  // Listener Transazioni
Â  Â  Â  Â  Â  Â  const transazioniQ = collection(db, getCollectionPath(TRANSAZIONI_COLLECTION));
Â  Â  Â  Â  Â  Â  onSnapshot(transazioniQ, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  // Ordina per data decrescente (ordinamento in client-side per evitare problemi di indicizzazione)
Â  Â  Â  Â  Â  Â  Â  Â  transactions.sort((a, b) => new Date(b.data) - new Date(a.data));
Â  Â  Â  Â  Â  Â  Â  Â  updateCalculations(); // Ricalcola tutto ad ogni aggiornamento
Â  Â  Â  Â  Â  Â  }, (error) => console.error("Errore listener Transazioni:", error));
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 5. RENDERING E UI
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  function showSection(sectionId) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#main-content section').forEach(section => {
Â  Â  Â  Â  Â  Â  Â  Â  section.classList.add('hidden');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById(sectionId).classList.remove('hidden');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se Ã¨ la sezione analytics, forziamo il rendering dei grafici
Â  Â  Â  Â  Â  Â  if (sectionId === 'analytics-section') {
Â  Â  Â  Â  Â  Â  Â  Â  // CORREZIONE GRAFICI: Assicuriamo che updateCalculations sia stato chiamato
Â  Â  Â  Â  Â  Â  Â  Â  // e che i dati siano pronti prima di chiamare renderAnalytics.
Â  Â  Â  Â  Â  Â  Â  Â  renderAnalytics();Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Aggiorna lo stato della navigazione
Â  Â  Â  Â  Â  Â  document.querySelectorAll('nav button').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('text-indigo-600');
Â  Â  Â  Â  Â  Â  Â  Â  if (btn.onclick.toString().includes(`showSection('${sectionId}')`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('text-indigo-600');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getEntityName(id, type) {
Â  Â  Â  Â  Â  Â  if (type === 'Acquisto') {
Â  Â  Â  Â  Â  Â  Â  Â  const supplier = suppliers.find(s => s.id === id);
Â  Â  Â  Â  Â  Â  Â  Â  return supplier ? (supplier.soprannome || supplier.nomeCompleto) : 'Fornitore Sconosciuto';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (type === 'Vendita') {
Â  Â  Â  Â  Â  Â  Â  Â  const customer = customers.find(c => c.id === id);
Â  Â  Â  Â  Â  Â  Â  Â  return customer ? (customer.soprannome || customer.nomeCompleto) : 'Cliente Sconosciuto';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return '';
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderTransactionList() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('transactions-container');
Â  Â  Â  Â  Â  Â  container.innerHTML = transactions.map(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const isAcquisto = t.tipo === 'Acquisto';
Â  Â  Â  Â  Â  Â  Â  Â  const isVendita = t.tipo === 'Vendita';
Â  Â  Â  Â  Â  Â  Â  Â  const color = isAcquisto ? 'bg-red-100 border-red-400' : isVendita ? 'bg-green-100 border-green-400' : 'bg-yellow-100 border-yellow-400';
Â  Â  Â  Â  Â  Â  Â  Â  const entityName = getEntityName(t.linkEntita, t.tipo);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let marginInfo = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (isVendita && averageUnitCost > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const costOfGoodsSold = (parseFloat(t.quantita) || 0) * averageUnitCost;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const profitMargin = (parseFloat(t.costo) || 0) - costOfGoodsSold;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  marginInfo = `<p class="text-sm font-semibold mt-1 ${profitMargin >= 0 ? 'text-green-700' : 'text-red-700'}">Margine: ${formatCurrency(profitMargin)}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 rounded-xl shadow-md border-l-4 ${color} flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-bold text-gray-800">${t.tipo} (${formatQuantity(t.quantita)})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAcquisto || isVendita ? `<p class="text-sm text-gray-600">${isAcquisto ? 'Costo' : 'Ricavo'}: <span class="font-bold">${formatCurrency(t.costo)}</span></p>` : `<p class="text-sm text-gray-600">Nessun impatto finanziario</p>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${marginInfo}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${entityName ? `<p class="text-xs text-gray-500 mt-1">${isAcquisto ? 'Fornitore' : 'Cliente'}: ${entityName}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">${new Date(t.data).toLocaleDateString('it-IT')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  if (transactions.length === 0) container.innerHTML = '<p class="text-center text-gray-500 p-4">Nessuna transazione registrata.</p>';
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderSuppliersList() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('suppliers-container');
Â  Â  Â  Â  Â  Â  container.innerHTML = suppliers.map(s => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-4 rounded-xl shadow flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-bold text-rice">${s.nomeCompleto} ${s.soprannome ? `(${s.soprannome})` : ''}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">Contatto: ${s.metodoContatto || 'N/D'} | Pagamento: ${s.metodoPagamento || 'N/D'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showSupplierModal('${s.id}')" class="ml-4 p-2 text-blue-500 hover:text-blue-700 transition">Modifica</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â  if (suppliers.length === 0) container.innerHTML = '<p class="text-center text-gray-500 p-4">Nessun fornitore registrato. Aggiungine uno!</p>';
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderCustomersList() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('customers-container');
Â  Â  Â  Â  Â  Â  container.innerHTML = customers.map(c => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-4 rounded-xl shadow flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-bold text-rice">${c.nomeCompleto} ${c.soprannome ? `(${c.soprannome})` : ''}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">Contatto: ${c.metodoContatto || 'N/D'} | Pagamento: ${c.metodoPagamento || 'N/D'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showCustomerModal('${c.id}')" class="ml-4 p-2 text-blue-500 hover:text-blue-700 transition">Modifica</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â  if (customers.length === 0) container.innerHTML = '<p class="text-center text-gray-500 p-4">Nessun cliente registrato. Aggiungine uno!</p>';
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 6. LOGICA E RENDERING ANALITICA (D3.js)
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  function renderAnalytics() {
Â  Â  Â  Â  Â  Â  if (transactions.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('flow-chart-container').innerHTML = '<p class="text-center text-gray-500 p-4">Nessun dato di transazione per l\'analisi.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('customer-chart-container').innerHTML = '<p class="text-center text-gray-500 p-4">Nessun dato di vendita per l\'analisi clienti.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  renderFlowChart();
Â  Â  Â  Â  Â  Â  renderCustomerChart();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Grafico Flusso di Riso (Acquisti vs Vendite) ---
Â  Â  Â  Â  function renderFlowChart() {
Â  Â  Â  Â  Â  Â  const containerId = 'flow-chart';
Â  Â  Â  Â  Â  Â  const data = transactions.filter(t => t.tipo === 'Acquisto' || t.tipo === 'Vendita').map(t => ({
Â  Â  Â  Â  Â  Â  Â  Â  date: new Date(t.data),
Â  Â  Â  Â  Â  Â  Â  Â  type: t.tipo,
Â  Â  Â  Â  Â  Â  Â  Â  quantity: parseFloat(t.quantita) || 0
Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  Â  Â  // 1. Aggregazione per Mese
Â  Â  Â  Â  Â  Â  const monthlyData = d3.rollups(
Â  Â  Â  Â  Â  Â  Â  Â  data,
Â  Â  Â  Â  Â  Â  Â  Â  v => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Acquisto: d3.sum(v, d => d.type === 'Acquisto' ? d.quantity : 0),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Vendita: d3.sum(v, d => d.type === 'Vendita' ? d.quantity : 0)
Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  Â  Â  d => d3.timeFormat("%Y-%m")(d.date) // Chiave: Anno-Mese
Â  Â  Â  Â  Â  Â  ).map(([key, value]) => ({
Â  Â  Â  Â  Â  Â  Â  Â  month: d3.timeParse("%Y-%m")(key),
Â  Â  Â  Â  Â  Â  Â  Â  Acquisto: value.Acquisto,
Â  Â  Â  Â  Â  Â  Â  Â  Vendita: value.Vendita
Â  Â  Â  Â  Â  Â  })).sort((a, b) => a.month - b.month);

Â  Â  Â  Â  Â  Â  if (monthlyData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  d3.select(`#${containerId}`).select("svg").html('<p class="text-center text-gray-500 p-4">Nessun dato di Acquisto o Vendita nel periodo.</p>');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Trasforma per lo stacked/grouped chart
Â  Â  Â  Â  Â  Â  const series = ['Acquisto', 'Vendita'].map(key => ({
Â  Â  Â  Â  Â  Â  Â  Â  key: key,
Â  Â  Â  Â  Â  Â  Â  Â  values: monthlyData.map(d => ({ date: d.month, quantity: d[key], type: key }))
Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  Â  Â  // 2. Setup D3
Â  Â  Â  Â  Â  Â  d3.select(`#${containerId}`).select("svg").selectAll("*").remove(); // Pulisce il grafico precedente
Â  Â  Â  Â  Â  Â  const svg = d3.select(`#${containerId}`).select("svg");
Â  Â  Â  Â  Â  Â  const margin = { top: 20, right: 20, bottom: 50, left: 60 };
Â  Â  Â  Â  Â  Â  const containerWidth = document.getElementById('flow-chart-container').clientWidth;
Â  Â  Â  Â  Â  Â  const width = Math.max(600, monthlyData.length * 50) - margin.left - margin.right; // Larghezza dinamica
Â  Â  Â  Â  Â  Â  const height = 300 - margin.top - margin.bottom;

Â  Â  Â  Â  Â  Â  svg.attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
Â  Â  Â  Â  Â  Â  Â  Â .attr("width", "100%")
Â  Â  Â  Â  Â  Â  Â  Â .attr("height", "100%"); // Rende SVG responsive

Â  Â  Â  Â  Â  Â  const g = svg.append("g")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("transform", `translate(${margin.left},${margin.top})`);

Â  Â  Â  Â  Â  Â  // 3. Scale
Â  Â  Â  Â  Â  Â  const x = d3.scaleBand()
Â  Â  Â  Â  Â  Â  Â  Â  .domain(monthlyData.map(d => d.month))
Â  Â  Â  Â  Â  Â  Â  Â  .range([0, width])
Â  Â  Â  Â  Â  Â  Â  Â  .paddingInner(0.1);

Â  Â  Â  Â  Â  Â  const y = d3.scaleLinear()
Â  Â  Â  Â  Â  Â  Â  Â  .domain([0, d3.max(monthlyData, d => Math.max(d.Acquisto, d.Vendita)) || 100])
Â  Â  Â  Â  Â  Â  Â  Â  .nice()
Â  Â  Â  Â  Â  Â  Â  Â  .range([height, 0]);

Â  Â  Â  Â  Â  Â  const color = d3.scaleOrdinal()
Â  Â  Â  Â  Â  Â  Â  Â  .domain(['Acquisto', 'Vendita'])
Â  Â  Â  Â  Â  Â  Â  Â  .range(['#ef4444', '#10b981']);

Â  Â  Â  Â  Â  Â  // 4. Assi
Â  Â  Â  Â  Â  Â  const xAxis = d3.axisBottom(x)
Â  Â  Â  Â  Â  Â  Â  Â  .tickFormat(d3.timeFormat("%b %y")); // Formato Mese Anno

Â  Â  Â  Â  Â  Â  g.append("g")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("transform", `translate(0,${height})`)
Â  Â  Â  Â  Â  Â  Â  Â  .call(xAxis)
Â  Â  Â  Â  Â  Â  Â  Â  .selectAll("text")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .style("text-anchor", "end")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("dx", "-.8em")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("dy", ".15em")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("transform", "rotate(-45)");

Â  Â  Â  Â  Â  Â  g.append("g")
Â  Â  Â  Â  Â  Â  Â  Â  .call(d3.axisLeft(y).tickFormat(d => `${d} g`));

Â  Â  Â  Â  Â  Â  // 5. Grafico a Barre
Â  Â  Â  Â  Â  Â  const barWidth = x.bandwidth() / series.length;

Â  Â  Â  Â  Â  Â  series.forEach((s, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  g.selectAll(`.bar-${s.key}`)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .data(s.values)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .enter().append("rect")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("class", `bar bar-${s.key}`)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("x", d => x(d.date) + (i * barWidth))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("y", d => y(d.quantity))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("width", barWidth)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("height", d => height - y(d.quantity))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("fill", color(s.key))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr("rx", 3); // Bordo arrotondato
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 6. Legenda
Â  Â  Â  Â  Â  Â  const legend = g.selectAll(".legend")
Â  Â  Â  Â  Â  Â  Â  Â  .data(series)
Â  Â  Â  Â  Â  Â  Â  Â  .enter().append("g")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("class", "legend")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("transform", (d, i) => `translate(${i * 100}, ${-10})`);

Â  Â  Â  Â  Â  Â  legend.append("rect")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("x", width - 18)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("width", 18)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("height", 18)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("fill", d => color(d.key))
Â  Â  Â  Â  Â  Â  Â  Â  .attr("rx", 3);

Â  Â  Â  Â  Â  Â  legend.append("text")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("x", width - 24)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("y", 9)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("dy", ".35em")
Â  Â  Â  Â  Â  Â  Â  Â  .style("text-anchor", "end")
Â  Â  Â  Â  Â  Â  Â  Â  .text(d => d.key)
Â  Â  Â  Â  Â  Â  Â  Â  .style("font-size", "12px");
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Grafico Performance Clienti ---
Â  Â  Â  Â  function renderCustomerChart() {
Â  Â  Â  Â  Â  Â  const containerId = 'customer-chart';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. Aggregazione per Cliente
Â  Â  Â  Â  Â  Â  const sales = transactions.filter(t => t.tipo === 'Vendita');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const customerSales = d3.rollups(
Â  Â  Â  Â  Â  Â  Â  Â  sales,
Â  Â  Â  Â  Â  Â  Â  Â  v => d3.sum(v, d => parseFloat(d.quantita) || 0),
Â  Â  Â  Â  Â  Â  Â  Â  d => d.linkEntita // Chiave: ID Cliente
Â  Â  Â  Â  Â  Â  ).map(([customerId, totalQuantity]) => ({
Â  Â  Â  Â  Â  Â  Â  Â  customerId,
Â  Â  Â  Â  Â  Â  Â  Â  totalQuantity,
Â  Â  Â  Â  Â  Â  Â  Â  customerName: getEntityName(customerId, 'Vendita')
Â  Â  Â  Â  Â  Â  })).filter(d => d.customerName !== 'Cliente Sconosciuto'); // Filtra i clienti non identificati

Â  Â  Â  Â  Â  Â  if (customerSales.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  d3.select(`#${containerId}`).select("svg").html('<p class="text-center text-gray-500 p-4">Nessun dato di vendita per l\'analisi clienti.</p>');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Ordina e prendi i Top 5 (e Bottom 5, se ce ne sono abbastanza)
Â  Â  Â  Â  Â  Â  customerSales.sort((a, b) => b.totalQuantity - a.totalQuantity);
Â  Â  Â  Â  Â  Â  const topCustomers = customerSales.slice(0, 5);
Â  Â  Â  Â  Â  Â  // Non visualizziamo i bottom 5 se i top 5 sono gli unici clienti. Semplifichiamo mostrando solo i top.
Â  Â  Â  Â  Â  Â  const data = topCustomers;

Â  Â  Â  Â  Â  Â  // 2. Setup D3
Â  Â  Â  Â  Â  Â  d3.select(`#${containerId}`).select("svg").selectAll("*").remove();
Â  Â  Â  Â  Â  Â  const svg = d3.select(`#${containerId}`).select("svg");
Â  Â  Â  Â  Â  Â  const margin = { top: 20, right: 20, bottom: 50, left: 100 };
Â  Â  Â  Â  Â  Â  const width = 600 - margin.left - margin.right;
Â  Â  Â  Â  Â  Â  const height = 300 - margin.top - margin.bottom;

Â  Â  Â  Â  Â  Â  svg.attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
Â  Â  Â  Â  Â  Â  Â  Â .attr("width", "100%")
Â  Â  Â  Â  Â  Â  Â  Â .attr("height", "100%");

Â  Â  Â  Â  Â  Â  const g = svg.append("g")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("transform", `translate(${margin.left},${margin.top})`);

Â  Â  Â  Â  Â  Â  // 3. Scale (Barre Orizzontali)
Â  Â  Â  Â  Â  Â  const x = d3.scaleLinear()
Â  Â  Â  Â  Â  Â  Â  Â  .domain([0, d3.max(data, d => d.totalQuantity) || 100])
Â  Â  Â  Â  Â  Â  Â  Â  .nice()
Â  Â  Â  Â  Â  Â  Â  Â  .range([0, width]);

Â  Â  Â  Â  Â  Â  const y = d3.scaleBand()
Â  Â  Â  Â  Â  Â  Â  Â  .domain(data.map(d => d.customerName))
Â  Â  Â  Â  Â  Â  Â  Â  .range([0, height])
Â  Â  Â  Â  Â  Â  Â  Â  .padding(0.2);

Â  Â  Â  Â  Â  Â  // 4. Assi
Â  Â  Â  Â  Â  Â  g.append("g")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("transform", `translate(0,${height})`)
Â  Â  Â  Â  Â  Â  Â  Â  .call(d3.axisBottom(x).tickFormat(d => `${d} g`));

Â  Â  Â  Â  Â  Â  g.append("g")
Â  Â  Â  Â  Â  Â  Â  Â  .call(d3.axisLeft(y));

Â  Â  Â  Â  Â  Â  // 5. Grafico a Barre
Â  Â  Â  Â  Â  Â  g.selectAll(".bar")
Â  Â  Â  Â  Â  Â  Â  Â  .data(data)
Â  Â  Â  Â  Â  Â  Â  Â  .enter().append("rect")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("class", "bar")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("x", 0)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("y", d => y(d.customerName))
Â  Â  Â  Â  Â  Â  Â  Â  .attr("width", d => x(d.totalQuantity))
Â  Â  Â  Â  Â  Â  Â  Â  .attr("height", y.bandwidth())
Â  Â  Â  Â  Â  Â  Â  Â  .attr("fill", "#6366f1") // Indigo
Â  Â  Â  Â  Â  Â  Â  Â  .attr("rx", 3);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Aggiungi etichette
Â  Â  Â  Â  Â  Â  g.selectAll(".label")
Â  Â  Â  Â  Â  Â  Â  Â  .data(data)
Â  Â  Â  Â  Â  Â  Â  Â  .enter().append("text")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("class", "label")
Â  Â  Â  Â  Â  Â  Â  Â  .attr("x", d => x(d.totalQuantity) - 5)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("y", d => y(d.customerName) + y.bandwidth() / 2)
Â  Â  Â  Â  Â  Â  Â  Â  .attr("dy", "0.35em")
Â  Â  Â  Â  Â  Â  Â  Â  .style("text-anchor", "end")
Â  Â  Â  Â  Â  Â  Â  Â  .text(d => formatQuantity(d.totalQuantity))
Â  Â  Â  Â  Â  Â  Â  Â  .style("fill", "white")
Â  Â  Â  Â  Â  Â  Â  Â  .style("font-size", "12px");
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 7. FUNZIONI MODAL E FORMS (CRUD)
Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CORREZIONE: Funzione di popolamento dei dropdown definita UNA sola volta.
Â  Â  Â  Â  function populateEntitySelects() {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('transaction-entity-link');
Â  Â  Â  Â  Â  Â  // Assicurati che l'elemento esista prima di procedere
Â  Â  Â  Â  Â  Â  if (!select) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  select.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const type = document.getElementById('transaction-type').value;
Â  Â  Â  Â  Â  Â  const entities = type === 'Acquisto' ? suppliers : customers;
Â  Â  Â  Â  Â  Â  const placeholderText = type === 'Acquisto' ? 'Seleziona Fornitore' : 'Seleziona Cliente';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  select.innerHTML += `<option value="" disabled selected>${placeholderText}</option>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  entities.forEach(e => {
Â  Â  Â  Â  Â  Â  Â  Â  const name = e.soprannome || e.nomeCompleto;
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML += `<option value="${e.id}">${name}</option>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Transazioni ---
Â  Â  Â  Â  function openTransactionModal(type) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('transaction-modal');
Â  Â  Â  Â  Â  Â  const title = document.getElementById('transaction-title');
Â  Â  Â  Â  Â  Â  const costGroup = document.getElementById('cost-ricavo-group');
Â  Â  Â  Â  Â  Â  const costInput = document.getElementById('transaction-cost');
Â  Â  Â  Â  Â  Â  const entityGroup = document.getElementById('entity-link-group');
Â  Â  Â  Â  Â  Â  const entityLabel = entityGroup.querySelector('label');
Â  Â  Â  Â  Â  Â  const entitySelect = document.getElementById('transaction-entity-link');

Â  Â  Â  Â  Â  Â  document.getElementById('transaction-form').reset();
Â  Â  Â  Â  Â  Â  document.getElementById('transaction-type').value = type;

Â  Â  Â  Â  Â  Â  if (type === 'Acquisto') {
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = 'Nuovo Acquisto';
Â  Â  Â  Â  Â  Â  Â  Â  costGroup.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  costInput.placeholder = 'Costo in â‚¬';
Â  Â  Â  Â  Â  Â  Â  Â  entityGroup.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  entityLabel.textContent = 'Fornitore';
Â  Â  Â  Â  Â  Â  Â  Â  entitySelect.setAttribute('required', 'required');
Â  Â  Â  Â  Â  Â  Â  Â  costInput.setAttribute('required', 'required');
Â  Â  Â  Â  Â  Â  } else if (type === 'Vendita') {
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = 'Nuova Vendita';
Â  Â  Â  Â  Â  Â  Â  Â  costGroup.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  costInput.placeholder = 'Ricavo in â‚¬';
Â  Â  Â  Â  Â  Â  Â  Â  entityGroup.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  entityLabel.textContent = 'Cliente';
Â  Â  Â  Â  Â  Â  Â  Â  entitySelect.setAttribute('required', 'required');
Â  Â  Â  Â  Â  Â  Â  Â  costInput.setAttribute('required', 'required');
Â  Â  Â  Â  Â  Â  } else { // Uso Personale
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = 'Uso Personale';
Â  Â  Â  Â  Â  Â  Â  Â  costGroup.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  costInput.removeAttribute('required');
Â  Â  Â  Â  Â  Â  Â  Â  entityGroup.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  entitySelect.removeAttribute('required');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  populateEntitySelects();
Â  Â  Â  Â  Â  Â  modal.classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeTransactionModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('transaction-modal').classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleTransaction(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  if (!isAuthReady) return console.error("Autenticazione non pronta.");

Â  Â  Â  Â  Â  Â  const type = document.getElementById('transaction-type').value;
Â  Â  Â  Â  Â  Â  const quantity = parseFloat(document.getElementById('transaction-quantity').value);
Â  Â  Â  Â  Â  Â  const costElement = document.getElementById('transaction-cost');
Â  Â  Â  Â  Â  Â  const cost = costElement.required ? parseFloat(costElement.value) : 0;
Â  Â  Â  Â  Â  Â  const entityIdElement = document.getElementById('transaction-entity-link');
Â  Â  Â  Â  Â  Â  const entityId = entityIdElement.required ? entityIdElement.value : null;

Â  Â  Â  Â  Â  Â  if (isNaN(quantity) || (costElement.required && isNaN(cost))) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Valori non validi.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Check inventario (semplificato: non impediamo la vendita, ma avvertiamo)
Â  Â  Â  Â  Â  Â  if ((type === 'Vendita' || type === 'Uso Personale') && quantity > riceInventory) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Attenzione: La quantitÃ  supera l'inventario disponibile (${formatQuantity(riceInventory)}).`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const newTransaction = {
Â  Â  Â  Â  Â  Â  Â  Â  tipo: type,
Â  Â  Â  Â  Â  Â  Â  Â  quantita: quantity,
Â  Â  Â  Â  Â  Â  Â  Â  costo: cost, // Usiamo 'costo' per tutti (costo negativo per Acquisto, positivo per Vendita)
Â  Â  Â  Â  Â  Â  Â  Â  linkEntita: entityId,
Â  Â  Â  Â  Â  Â  Â  Â  data: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  // Campi calcolati in app, non salvati: costoUnitario, ricavoUnitario.
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const colRef = collection(db, getCollectionPath(TRANSAZIONI_COLLECTION));
Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(colRef, newTransaction);
Â  Â  Â  Â  Â  Â  Â  Â  closeTransactionModal();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore nell'aggiunta della transazione:", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Fornitori (CRUD) ---
Â  Â  Â  Â  function showSupplierModal(docId = null) {
Â  Â  Â  Â  Â  Â  document.getElementById('supplier-form').reset();
Â  Â  Â  Â  Â  Â  document.getElementById('supplier-doc-id').value = docId || '';

Â  Â  Â  Â  Â  Â  if (docId) {
Â  Â  Â  Â  Â  Â  Â  Â  const supplier = suppliers.find(s => s.id === docId);
Â  Â  Â  Â  Â  Â  Â  Â  if (supplier) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('supplier-name').value = supplier.nomeCompleto || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('supplier-alias').value = supplier.soprannome || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('supplier-phone').value = supplier.numeroTelefono || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('supplier-contact-method').value = supplier.metodoContatto || 'WhatsApp';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('supplier-payment-method').value = supplier.metodoPagamento || 'Contanti';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('supplier-modal').classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function closeSupplierModal() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('supplier-modal').classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleSupplier(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  if (!isAuthReady) return console.error("Autenticazione non pronta.");

Â  Â  Â  Â  Â  Â  const docId = document.getElementById('supplier-doc-id').value;
Â  Â  Â  Â  Â  Â  const supplierData = {
Â  Â  Â  Â  Â  Â  Â  Â  nomeCompleto: document.getElementById('supplier-name').value,
Â  Â  Â  Â  Â  Â  Â  Â  soprannome: document.getElementById('supplier-alias').value,
Â  Â  Â  Â  Â  Â  Â  Â  numeroTelefono: document.getElementById('supplier-phone').value,
Â  Â  Â  Â  Â  Â  Â  Â  metodoContatto: document.getElementById('supplier-contact-method').value,
Â  Â  Â  Â  Â  Â  Â  Â  metodoPagamento: document.getElementById('supplier-payment-method').value,
Â  Â  Â  Â  Â  Â  Â  Â  immagineProfilo: 'placeholder_url' // Mock data
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (docId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, getCollectionPath(FORNITORI_COLLECTION), docId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(docRef, supplierData, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colRef = collection(db, getCollectionPath(FORNITORI_COLLECTION));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(colRef, supplierData);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  closeSupplierModal();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore nel salvataggio del fornitore:", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Clienti (CRUD - Logica Identica a Fornitori) ---
Â  Â  Â  Â  function showCustomerModal(docId = null) {
Â  Â  Â  Â  Â  Â  document.getElementById('customer-form').reset();
Â  Â  Â  Â  Â  Â  document.getElementById('customer-doc-id').value = docId || '';

Â  Â  Â  Â  Â  Â  if (docId) {
Â  Â  Â  Â  Â  Â  Â  Â  const customer = customers.find(c => c.id === docId);
Â  Â  Â  Â  Â  Â  Â  Â  if (customer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('customer-name').value = customer.nomeCompleto || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('customer-alias').value = customer.soprannome || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('customer-phone').value = customer.numeroTelefono || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('customer-contact-method').value = customer.metodoContatto || 'WhatsApp';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('customer-payment-method').value = customer.metodoPagamento || 'Contanti';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('customer-modal').classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeCustomerModal() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('customer-modal').classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleCustomer(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  if (!isAuthReady) return console.error("Autenticazione non pronta.");

Â  Â  Â  Â  Â  Â  const docId = document.getElementById('customer-doc-id').value;
Â  Â  Â  Â  Â  Â  const customerData = {
Â  Â  Â  Â  Â  Â  Â  Â  nomeCompleto: document.getElementById('customer-name').value,
Â  Â  Â  Â  Â  Â  Â  Â  soprannome: document.getElementById('customer-alias').value,
Â  Â  Â  Â  Â  Â  Â  Â  numeroTelefono: document.getElementById('customer-phone').value,
Â  Â  Â  Â  Â  Â  Â  Â  metodoContatto: document.getElementById('customer-contact-method').value,
Â  Â  Â  Â  Â  Â  Â  Â  metodoPagamento: document.getElementById('customer-payment-method').value,
Â  Â  Â  Â  Â  Â  Â  Â  immagineProfilo: 'placeholder_url' // Mock data
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (docId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, getCollectionPath(CLIENTI_COLLECTION), docId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(docRef, customerData, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colRef = collection(db, getCollectionPath(CLIENTI_COLLECTION));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(colRef, customerData);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  closeCustomerModal();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore nel salvataggio del cliente:", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 8. FUNZIONI GEMINI API (Pianificatore Scorte)
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  // Helper per gestione errori e backoff (necessario per le API calls)
Â  Â  Â  Â  async function exponentialBackoffFetch(url, options, maxRetries = 5, delay = 1000) {
Â  Â  Â  Â  Â  Â  for (let i = 0; i < maxRetries; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url, options);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.status !== 429) { // Non Ã¨ un errore di Rate Limit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return response;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Rate limit hit. Retrying in ${delay}ms...`);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i === maxRetries - 1) throw error;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Fetch attempt failed: ${error.message}. Retrying...`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  delay *= 2;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  throw new Error("Max retries exceeded.");
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleStockPlanner() {
Â  Â  Â  Â  Â  Â  const modalContent = document.getElementById('stock-planner-result-content');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (monthlyConsumption === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  modalContent.innerHTML = `<p class="text-center text-yellow-600 font-semibold">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Non ci sono abbastanza dati di Vendita o Uso Personale per calcolare il consumo medio.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Per un suggerimento accurato, registra almeno un paio di transazioni di Vendita/Uso Personale.
Â  Â  Â  Â  Â  Â  Â  Â  </p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const safetyStockDays = 10; // Un buffer di 10 giorni
Â  Â  Â  Â  Â  Â  const dailyConsumptionRate = monthlyConsumption / 30.44;
Â  Â  Â  Â  Â  Â  const safetyStock = dailyConsumptionRate * safetyStockDays;
Â  Â  Â  Â  Â  Â  const inventoryDaysLeft = riceInventory > 0 ? (riceInventory / dailyConsumptionRate) : 0;
Â  Â  Â  Â  Â  Â  const isCritical = riceInventory <= safetyStock;
Â  Â  Â  Â  Â  Â  const daysUntilReorder = inventoryDaysLeft - safetyStockDays;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const actionRequired = isCritical ? "azione IMMEDIATA" : "monitoraggio";

Â  Â  Â  Â  Â  Â  const stockDetails = {
Â  Â  Â  Â  Â  Â  Â  Â  inventario_attuale_g: riceInventory,
Â  Â  Â  Â  Â  Â  Â  Â  consumo_medio_mensile_g: monthlyConsumption,
Â  Â  Â  Â  Â  Â  Â  Â  giorni_di_copertura_rimanenti: inventoryDaysLeft,
Â  Â  Â  Â  Â  Â  Â  Â  quantita_riordino_suggerita_g: monthlyConsumption * 1.5, // Suggerisci 1.5 mesi di scorta
Â  Â  Â  Â  Â  Â  Â  Â  fornitori_disponibili: suppliers.map(s => s.nomeCompleto).join(', ') || "Nessun fornitore registrato"
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const systemPrompt = `Sei un esperto di pianificazione scorte (Inventory Planner). Analizza i dati forniti per determinare lo stato delle scorte di riso. La tua unica funzione Ã¨ fornire un'analisi concisa (massimo 3 paragrafi) che risponda a due domande: 1. Lo stato Ã¨ critico e quanto tempo (giorni) manca prima di raggiungere il livello di scorta di sicurezza? 2. Qual Ã¨ la quantitÃ  di riordino suggerita in base al consumo medio mensile per coprire 1.5 mesi? La risposta deve essere in italiano e non deve contenere grounding o citazioni web.`;
Â  Â  Â  Â  Â  Â  const userQuery = `Analizza questa situazione di inventario per chicchi di riso:\nInventario attuale: ${stockDetails.inventario_attuale_g} grammi.\nConsumo medio mensile (Vendite + Uso Personale): ${stockDetails.consumo_medio_mensile_g.toFixed(0)} grammi.\nScorta di sicurezza: ${safetyStockDays} giorni di consumo (${formatQuantity(safetyStock)}).\nAzioni richieste: ${actionRequired}.\nFornitori registrati: ${stockDetails.fornitori_disponibili}`;

Â  Â  Â  Â  Â  Â  modalContent.innerHTML = `<p class="text-center text-indigo-600 font-bold flex items-center justify-center"><div class="spinner"></div> Analisi Scorte in corso...</p>`;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await exponentialBackoffFetch(`${GEMINI_API_URL}?key=${apiKey}`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contents: [{ parts: [{ text: userQuery }] }],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  systemInstruction: { parts: [{ text: systemPrompt }] }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Non usiamo tools: google_search, perchÃ© l'analisi Ã¨ solo interna
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Errore nella generazione dell'analisi AI.";

Â  Â  Â  Â  Â  Â  Â  Â  const headerColor = isCritical ? 'text-red-600' : (inventoryDaysLeft < 30 ? 'text-orange-500' : 'text-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  const daysLeftText = isCritical ? `**SCORTA CRITICA: Solo ${formatQuantity(riceInventory)} rimanenti!**` : `Hai copertura per circa ${inventoryDaysLeft.toFixed(1)} giorni.`;
Â  Â  Â  Â  Â  Â  Â  Â  const reorderCall = isCritical ? `**AZIONE IMMEDIATA:** Contatta i fornitori. QuantitÃ  suggerita: ${formatQuantity(stockDetails.quantita_riordino_suggerita_g)}.` : `Livello scorta di sicurezza (copertura 10 giorni): ${formatCurrency(safetyStock)}. Nessun riordino urgente richiesto.`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Formatta l'output finale
Â  Â  Â  Â  Â  Â  Â  Â  modalContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-bold ${headerColor}">Riepilogo Scorte Attuale:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside space-y-1 text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Inventario: <span class="font-bold">${formatQuantity(riceInventory)}</span></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Consumo Medio Mensile: <span class="font-bold">${formatQuantity(monthlyConsumption)}</span></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>Giorni di Copertura Totale: <span class="font-bold">${inventoryDaysLeft.toFixed(1)} giorni</span></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-t border-gray-300 pt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-lg font-semibold ${headerColor} mb-2">${daysLeftText}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-lg font-semibold text-indigo-700">${reorderCall}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="border-t border-gray-300 pt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4 class="text-md font-bold text-gray-800">Analisi e Suggerimenti AI:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="prose max-w-none text-gray-700 mt-2">${text}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore chiamata Gemini API:", error);
Â  Â  Â  Â  Â  Â  Â  Â  modalContent.innerHTML = `<p class="text-red-500">Si Ã¨ verificato un errore durante l'analisi AI. Riprova piÃ¹ tardi. (Errore Gemini: Chiave non valida o utilizzo esaurito).</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function openStockPlannerModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('stock-planner-modal').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  handleStockPlanner(); // Avvia l'analisi non appena il modal si apre
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeStockPlannerModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('stock-planner-modal').classList.add('hidden');
Â  Â  Â  Â  }


Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 9. AVVIO APPLICAZIONE
Â  Â  Â  Â  // ---------------------------------------------------


Â  Â  Â  Â  window.showSection = showSection;
Â  Â  Â  Â  window.openTransactionModal = openTransactionModal;
Â  Â  Â  Â  window.closeTransactionModal = closeTransactionModal;
Â  Â  Â  Â  window.handleTransaction = handleTransaction;
Â  Â  Â  Â  window.showSupplierModal = showSupplierModal;
Â  Â  Â  Â  window.closeSupplierModal = closeSupplierModal;
Â  Â  Â  Â  window.handleSupplier = handleSupplier;
Â  Â  Â  Â  window.showCustomerModal = showCustomerModal;
Â  Â  Â  Â  window.closeCustomerModal = closeCustomerModal;
Â  Â  Â  Â  window.handleCustomer = handleCustomer;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Funzioni Gemini (Aggiornate)
Â  Â  Â  Â  window.openStockPlannerModal = openStockPlannerModal;
Â  Â  Â  Â  window.closeStockPlannerModal = closeStockPlannerModal;
Â  Â  Â  Â Â 
Â  Â  Â  Â  initFirebase();

Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // 10. REGISTRAZIONE SERVICE WORKER (PWA) <--- NUOVO CODICE
Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('/sw.js')
Â  Â  Â  Â  Â  Â  Â  .then(registration => {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ServiceWorker registration successful with scope: ', registration.scope);
Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ServiceWorker registration failed: ', error);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
